name: release

on:
  workflow_dispatch:
# release:
#   types: [published]

jobs:

  build:
    name: Build
    runs-on: windows-latest
    permissions:
      packages: write

    steps:

    - name: Set up .NET
      uses: actions/setup-dotnet@v4

    - name: Check out code
      uses: actions/checkout@v4

    - name: Install fantomas
      run: |
        dotnet tool install fantomas

    - name: Build
      run: |
        dotnet --version
        make build-all
        make integration-tests

    - name: Package artifacts
      run: |
        make release

    - name: Publish to Github packages
      run: |
        dotnet nuget add source --username uhppoted --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/uhppoted/index.json"
        dotnet nuget push ./uhppoted/uhppoted/dist/uhppoted-test.0.8.9.3-alpha.nupkg  --source "github" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
        dotnet nuget push ./uhppoted/uhppoted/dist/uhppoted-test.0.8.9.3-alpha.snupkg --source "github" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate

    - name: Publish to nuget.org
      run: |
        dotnet nuget push ./uhppoted/uhppoted/dist/uhppoted-test.0.8.9.3-alpha.nupkg --source "https://api.nuget.org/v3/index.json" --api-key ${{ secrets.NUGET_API_KEY }} --skip-duplicate
